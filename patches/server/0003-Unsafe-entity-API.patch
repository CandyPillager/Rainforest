From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Mariell Hoversholm <proximyst@proximyst.com>
Date: Fri, 17 Jul 2020 21:34:45 +0200
Subject: [PATCH] Unsafe entity API

---
 .../craftbukkit/entity/CraftEntity.java       | 26 ++++++++++++
 .../craftbukkit/entity/CraftPlayer.java       | 42 ++++++++++++++++++-
 2 files changed, 67 insertions(+), 1 deletion(-)

diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
index 6f59f8d4541451573eb50a1a3190788c51490502..326168dda65b47ac8ecf41a7186a32a235d6da50 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
@@ -6,6 +6,7 @@ import com.google.common.collect.Lists;
 import java.util.List;
 import java.util.Set;
 import java.util.UUID;
+import javax.annotation.concurrent.NotThreadSafe;
 import net.minecraft.server.AxisAlignedBB;
 import net.minecraft.server.BlockPosition;
 import net.minecraft.server.DamageSource;
@@ -1126,4 +1127,29 @@ public abstract class CraftEntity implements org.bukkit.entity.Entity {
         return getHandle().isTicking();
     }
     // Paper end
+
+    // Rainforest start
+    private final Unsafe unsafe = new Unsafe() {
+        @Override
+        public void rotate(float yaw, float pitch) {
+            getHandle().yaw = yaw;
+            getHandle().pitch = pitch;
+        }
+
+        @Override
+        public void setInvisible(boolean invisibility) {
+            getHandle().setInvisible(invisibility);
+        }
+
+        @Override
+        public void setInvulnerable(boolean invulnerablity) {
+            getHandle().setInvulnerable(invulnerablity);
+        }
+    };
+
+    @Override
+    public Unsafe getUnsafeApi() {
+        return unsafe;
+    }
+    // Rainforest end
 }
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 7e91e95941039cce630ed3eb88e1919e1d08c091..7f6753a4cfc76a1385f55a852726920a15b718ff 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -52,8 +52,10 @@ import net.minecraft.server.PacketPlayOutBlockChange;
 import net.minecraft.server.PacketPlayOutChat;
 import net.minecraft.server.PacketPlayOutCustomPayload;
 import net.minecraft.server.PacketPlayOutCustomSoundEffect;
+import net.minecraft.server.PacketPlayOutEntityDestroy;
 import net.minecraft.server.PacketPlayOutExperience;
 import net.minecraft.server.PacketPlayOutMap;
+import net.minecraft.server.PacketPlayOutMount;
 import net.minecraft.server.PacketPlayOutNamedSoundEffect;
 import net.minecraft.server.PacketPlayOutPlayerInfo;
 import net.minecraft.server.PacketPlayOutPlayerListHeaderFooter;
@@ -114,6 +116,7 @@ import org.bukkit.craftbukkit.util.CraftMagicNumbers;
 import org.bukkit.craftbukkit.util.CraftNamespacedKey;
 import org.bukkit.entity.EntityType;
 import org.bukkit.entity.Player;
+import org.bukkit.entity.Player.Unsafe;
 import org.bukkit.event.player.PlayerRegisterChannelEvent;
 import org.bukkit.event.player.PlayerTeleportEvent;
 import org.bukkit.event.player.PlayerUnregisterChannelEvent;
@@ -819,7 +822,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
     public boolean setPassenger(org.bukkit.entity.Entity passenger) {
         boolean wasSet = super.setPassenger(passenger);
         if (wasSet) {
-            this.getHandle().playerConnection.sendPacket(new net.minecraft.server.PacketPlayOutMount(this.getHandle()));
+            this.getHandle().playerConnection.sendPacket(new PacketPlayOutMount(this.getHandle()));
         }
         return wasSet;
     }
@@ -2155,4 +2158,41 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         return spigot;
     }
     // Spigot end
+
+    // Rainforest start
+    private final Player.Unsafe unsafe = new Player.Unsafe() {
+        @Override
+        public void destroyEntity(org.bukkit.entity.Entity entity) {
+            if (getHandle().playerConnection == null) return;
+            getHandle().playerConnection.sendPacket(new PacketPlayOutEntityDestroy(entity.getEntityId()));
+        }
+
+        @Override
+        public void updatePassengers() {
+            if (getHandle().playerConnection == null) return;
+            getHandle().playerConnection.sendPacket(new PacketPlayOutMount(getHandle()));
+        }
+
+        @Override
+        public void rotate(float yaw, float pitch) {
+            getHandle().yaw = yaw;
+            getHandle().pitch = pitch;
+        }
+
+        @Override
+        public void setInvisible(boolean invisibility) {
+            getHandle().setInvisible(invisibility);
+        }
+
+        @Override
+        public void setInvulnerable(boolean invulnerablity) {
+            getHandle().setInvulnerable(invulnerablity);
+        }
+    };
+
+    @Override
+    public Player.Unsafe getUnsafeApi() {
+        return unsafe;
+    }
+    // Rainforest end
 }
