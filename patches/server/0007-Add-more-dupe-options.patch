From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Mariell Hoversholm <proximyst@proximyst.com>
Date: Sat, 18 Jul 2020 12:03:44 +0200
Subject: [PATCH] Add more dupe options

---
 .../java/com/proximyst/rainforest/RainforestConfig.java  | 9 +++++++++
 .../com/proximyst/rainforest/RainforestWorldConfig.java  | 5 +++++
 src/main/java/net/minecraft/server/Entity.java           | 8 +++++---
 .../java/net/minecraft/server/EntityEnderDragon.java     | 1 +
 .../java/net/minecraft/server/EntityFallingBlock.java    | 5 +++--
 src/main/java/net/minecraft/server/EntityPlayer.java     | 3 ++-
 src/main/java/net/minecraft/server/PlayerConnection.java | 3 ++-
 .../org/bukkit/craftbukkit/event/CraftEventFactory.java  | 2 ++
 8 files changed, 29 insertions(+), 7 deletions(-)

diff --git a/src/main/java/com/proximyst/rainforest/RainforestConfig.java b/src/main/java/com/proximyst/rainforest/RainforestConfig.java
index 1d28680bed17739f026b799da25d07358b2cb2b5..0f28265e7e59e83ca972199bc7316f2a6594c1be 100644
--- a/src/main/java/com/proximyst/rainforest/RainforestConfig.java
+++ b/src/main/java/com/proximyst/rainforest/RainforestConfig.java
@@ -190,4 +190,13 @@ public final class RainforestConfig {
   private static void asyncAdvancements() {
     asyncAdvancements = getBoolean("async-advancements", asyncAdvancements);
   }
+
+  public static boolean allowPlayerItemDuplication = false;
+  public static boolean allowRidableChestDuping = false;
+  public static boolean allowSandDuping = false;
+  private static void dupeOptions() {
+    allowPlayerItemDuplication = getBoolean("allow-player-item-duplication", allowPlayerItemDuplication);
+    allowRidableChestDuping = getBoolean("allow-ridable-chestable-duping", allowRidableChestDuping);
+    allowSandDuping = getBoolean("allow-sand-duping", allowSandDuping);
+  }
 }
diff --git a/src/main/java/com/proximyst/rainforest/RainforestWorldConfig.java b/src/main/java/com/proximyst/rainforest/RainforestWorldConfig.java
index 22d920686418e86aec8be37f125123682af023a3..ff5970377ad1d71ec4065938a62bd5a7261e1fbc 100644
--- a/src/main/java/com/proximyst/rainforest/RainforestWorldConfig.java
+++ b/src/main/java/com/proximyst/rainforest/RainforestWorldConfig.java
@@ -65,4 +65,9 @@ public final class RainforestWorldConfig {
     return config
         .getString("world-settings." + worldName + "." + path, config.getString("world-settings.default." + path));
   }
+
+  public boolean allowEnderDragonExpDuping = false;
+  private void dupeOptions() {
+    allowEnderDragonExpDuping = getBoolean("allow-dragon-exp-duping", allowEnderDragonExpDuping);
+  }
 }
diff --git a/src/main/java/net/minecraft/server/Entity.java b/src/main/java/net/minecraft/server/Entity.java
index 9c4b02d776f8b99c6703c8dfc5d9fac0702bbe80..98a1728503fdd6460bc7c9003eabffa333df4f9c 100644
--- a/src/main/java/net/minecraft/server/Entity.java
+++ b/src/main/java/net/minecraft/server/Entity.java
@@ -5,6 +5,7 @@ import co.aikar.timings.Timing;
 import com.google.common.collect.Iterables;
 import com.google.common.collect.Lists;
 import com.google.common.collect.Sets;
+import com.proximyst.rainforest.RainforestConfig;
 import it.unimi.dsi.fastutil.objects.Object2DoubleArrayMap;
 import it.unimi.dsi.fastutil.objects.Object2DoubleMap;
 import org.apache.logging.log4j.LogManager;
@@ -1936,6 +1937,7 @@ public abstract class Entity implements INamableTileEntity, ICommandListener, Ke
             }
             // CraftBukkit end
             EntityItem entityitem = new EntityItem(this.world, this.locX(), this.locY() + (double) f, this.locZ(), itemstack.cloneItemStack()); // Paper - clone so we can destroy original
+            if (!RainforestConfig.allowRidableChestDuping) // Rainforest
             itemstack.setCount(0); // Paper - destroy this item - if this ever leaks due to game bugs, ensure it doesn't dupe
 
             entityitem.defaultPickupDelay();
@@ -2588,7 +2590,7 @@ public abstract class Entity implements INamableTileEntity, ICommandListener, Ke
     public Entity teleportTo(WorldServer worldserver, BlockPosition location) {
         // CraftBukkit end
         // Paper start - fix bad state entities causing dupes
-        if (!isAlive() || !valid) {
+        if (!RainforestConfig.allowRidableChestDuping && (!isAlive() || !valid)) { // Rainforest
             LOGGER.warn("Illegal Entity Teleport " + this + " to " + worldserver + ":" + location, new Throwable());
             return null;
         }
@@ -2696,7 +2698,7 @@ public abstract class Entity implements INamableTileEntity, ICommandListener, Ke
                 entity.bukkitEntity = this.getBukkitEntity();
 
                 if (this instanceof EntityInsentient) {
-                    ((EntityInsentient)this).unleash(true, true); // Paper drop lead
+                    ((EntityInsentient)this).unleash(true, !RainforestConfig.allowRidableChestDuping); // Paper drop lead // Rainforest
                 }
                 // CraftBukkit end
             }
@@ -2717,7 +2719,7 @@ public abstract class Entity implements INamableTileEntity, ICommandListener, Ke
     }
 
     public boolean canPortal() {
-        return isAlive() && valid; // Paper
+        return RainforestConfig.allowRidableChestDuping || isAlive() && valid; // Paper // Rainforest
     }
 
     public float a(Explosion explosion, IBlockAccess iblockaccess, BlockPosition blockposition, IBlockData iblockdata, Fluid fluid, float f) {
diff --git a/src/main/java/net/minecraft/server/EntityEnderDragon.java b/src/main/java/net/minecraft/server/EntityEnderDragon.java
index 63a759cc18b5b765bc9d34f71dd775fd35dee280..56e6df1ae48bad4a247f986a19d373fbd4e04c3a 100644
--- a/src/main/java/net/minecraft/server/EntityEnderDragon.java
+++ b/src/main/java/net/minecraft/server/EntityEnderDragon.java
@@ -839,6 +839,7 @@ public class EntityEnderDragon extends EntityInsentient implements IMonster {
         if (nbttagcompound.hasKey("DragonPhase")) {
             this.bN.setControllerPhase(DragonControllerPhase.getById(nbttagcompound.getInt("DragonPhase")));
         }
+        if (!world.rainforestConfig.allowEnderDragonExpDuping) // Rainforest
         this.deathAnimationTicks = nbttagcompound.getInt("Paper.DeathTick"); // Paper
 
     }
diff --git a/src/main/java/net/minecraft/server/EntityFallingBlock.java b/src/main/java/net/minecraft/server/EntityFallingBlock.java
index 6697b94550054ebbc8d4b3761bd9f36eb7e4ba8a..6ca56271e817b730c15392dc078e025aad0baaaf 100644
--- a/src/main/java/net/minecraft/server/EntityFallingBlock.java
+++ b/src/main/java/net/minecraft/server/EntityFallingBlock.java
@@ -1,6 +1,7 @@
 package net.minecraft.server;
 
 import com.google.common.collect.Lists;
+import com.proximyst.rainforest.RainforestConfig;
 import java.util.Iterator;
 import java.util.List;
 
@@ -65,7 +66,7 @@ public class EntityFallingBlock extends Entity {
     @Override
     public void tick() {
         // Paper start - fix sand duping
-        if (this.dead) {
+        if (this.dead && !RainforestConfig.allowSandDuping) { // Rainforest
             return;
         }
         // Paper end - fix sand duping
@@ -92,7 +93,7 @@ public class EntityFallingBlock extends Entity {
             this.move(EnumMoveType.SELF, this.getMot());
 
             // Paper start - fix sand duping
-            if (this.dead) {
+            if (this.dead && !RainforestConfig.allowSandDuping) { // Rainforest
                 return;
             }
             // Paper end - fix sand duping
diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index b39e98a0612198a642e4530b56e854349d4b719c..c260ca27098c46d37a6fdec86f018decf227c374 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -7,6 +7,7 @@ import com.mojang.authlib.GameProfile;
 import com.mojang.datafixers.util.Either;
 import com.mojang.serialization.DataResult;
 import com.proximyst.rainforest.AdvancementDataPlayerDelegate;
+import com.proximyst.rainforest.RainforestConfig;
 import java.util.ArrayDeque;
 import java.util.Collection;
 import java.util.Deque;
@@ -2118,7 +2119,7 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
 
     @Override
     public boolean isFrozen() { // Paper - protected > public
-        return super.isFrozen() || (this.playerConnection != null && this.playerConnection.isDisconnected()); // Paper
+        return super.isFrozen() || (RainforestConfig.allowPlayerItemDuplication ? !this.playerConnection.isDisconnected() : this.playerConnection != null && this.playerConnection.isDisconnected()); // Paper // Rainforest
     }
 
     @Override
diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index 98e6d5e7abb27550ae5ff024b31203ed2871678d..84b113781f40f1eaf606aaca3373d359762b34b4 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -4,6 +4,7 @@ import com.google.common.primitives.Doubles;
 import com.google.common.primitives.Floats;
 import com.mojang.brigadier.ParseResults;
 import com.mojang.brigadier.StringReader;
+import com.proximyst.rainforest.RainforestConfig;
 import io.netty.util.concurrent.Future;
 import io.netty.util.concurrent.GenericFutureListener;
 import it.unimi.dsi.fastutil.ints.Int2ShortMap;
@@ -2776,7 +2777,7 @@ public class PlayerConnection implements PacketListenerPlayIn {
     }
 
     public final boolean isDisconnected() {
-        return (!this.player.joining && !this.networkManager.isConnected()) || this.processedDisconnect; // Paper
+        return (!this.player.joining && !this.networkManager.isConnected()) || RainforestConfig.allowPlayerItemDuplication || this.processedDisconnect; // Paper // Rainforest
     }
     // CraftBukkit end
 
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index ddb58c1d502b6eaaee146eaa61d97cf5740d3990..527df78a96b64599293cc13afbd2a238d47d3196 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -4,6 +4,7 @@ import com.google.common.base.Function;
 import com.google.common.base.Functions;
 import com.google.common.collect.Lists;
 import com.mojang.datafixers.util.Either;
+import com.proximyst.rainforest.RainforestConfig;
 import java.net.InetAddress;
 import java.util.ArrayList;
 import java.util.Collections;
@@ -805,6 +806,7 @@ public class CraftEventFactory {
             if (stack == null || stack.getType() == Material.AIR || stack.getAmount() == 0) continue;
 
             world.dropItem(entity.getLocation(), stack); // Paper - note: dropItem already clones due to this being bukkit -> NMS
+            if (!RainforestConfig.allowRidableChestDuping) // Rainforest
             if (stack instanceof CraftItemStack) stack.setAmount(0); // Paper - destroy this item - if this ever leaks due to game bugs, ensure it doesn't dupe, but don't nuke bukkit stacks of manually added items
         }
 
